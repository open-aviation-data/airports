name: Process Airport Updates

on:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  process-update:
    if: contains(github.event.issue.labels.*.name, 'update airport')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Extract Issue Data
        id: extract
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body.split('\n').map(l => l.trim());
            
            // Simple field extraction (assumes ### Field Name followed by value)
            const fields = {};
            let currentField = null;
            
            body.forEach(line => {
              const fieldMatch = line.match(/^### (.+)/);
              if (fieldMatch) {
                currentField = fieldMatch[1].trim();
                fields[currentField] = '';
              } else if (currentField && line && line !== '_No response_') {
                fields[currentField] = line;
              }
            });
            
            // Validate required fields
            const errors = [];
            if (!fields['Numeric ID']) errors.push('Missing Numeric ID');
            if (!fields['Airport Name']) errors.push('Missing Airport Name');
            
            // Generate branch name
            const branchName = `update-airport-${fields['Numeric ID']}-${
              fields['Airport Name'].toLowerCase().replace(/[^a-z0-9]+/g, '-')
            }-${Date.now()}`;
            
            return {
              fields: JSON.stringify(fields),
              branch_name: branchName,
              errors: errors.join('; ')
            };

      - name: Validate Numeric ID
        id: validate
        run: |
          NUMERIC_ID=$(jq -r '."Numeric ID"' <<< '${{ steps.extract.outputs.fields }}')
          if ! grep -q "^$NUMERIC_ID," data/airports.csv; then
            echo "error=Numeric ID $NUMERIC_ID not found in CSV" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Get Existing Data
        id: existing
        run: |
          NUMERIC_ID=$(jq -r '."Numeric ID"' <<< '${{ steps.extract.outputs.fields }}')
          echo "row=$(grep "^$NUMERIC_ID," data/airports.csv)" >> $GITHUB_OUTPUT

      - name: Merge Data
        id: merge
        run: |
          IFS=',' read -ra OLD < <(echo "${{ steps.existing.outputs.row }}")
          FIELDS='${{ steps.extract.outputs.fields }}'
          
          # Map issue fields to CSV columns (0-based index)
          declare -A COLUMN_MAP=(
            ["ICAO Code"]=2
            ["IATA Code"]=3
            ["Airport Name"]=6
            ["Latitude"]=7
            ["Longitude"]=8
            ["Country"]=11
            ["Municipality"]=13
            ["New Official Website URL (if applicable)"]=15
            ["New Wikipedia URL (if applicable)"]=16
            ["Keywords"]=17
            ["Timezone"]=18
            ["Airport Type (if changing)"]=19
          )
          
          NEW_ROW=()
          for i in "${!OLD[@]}"; do
            NEW_ROW[i]="${OLD[$i]}"
          done
          
          # Update fields from issue
          for field in "${!COLUMN_MAP[@]}"; do
            value=$(jq -r ".[\"$field\"] // empty" <<< "$FIELDS")
            index=${COLUMN_MAP[$field]}
          
            if [ -n "$value" ] && [ "$value" != "None" ] && [ "$value" != "No Change" ]; then
              NEW_ROW[$index]="$value"
            fi
          done
          
          # Join array back to CSV
          UPDATED_ROW=$(IFS=','; echo "${NEW_ROW[*]}")
          echo "updated_row=$UPDATED_ROW" >> $GITHUB_OUTPUT

      - name: Create Branch
        run: |
          git checkout -b ${{ steps.extract.outputs.branch_name }}
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Update CSV
        run: |
          NUMERIC_ID=$(jq -r '."Numeric ID"' <<< '${{ steps.extract.outputs.fields }}')
          awk -v id="$NUMERIC_ID" -v new="${{ steps.merge.outputs.updated_row }}" '
            BEGIN {FS=OFS=","} 
            $1 == id {$0 = new} 
            {print}
          ' data/airports.csv > tmp.csv && mv tmp.csv data/airports.csv
          
          git add data/airports.csv
          git commit -m "Update airport $NUMERIC_ID: $(echo '${{ steps.extract.outputs.fields }}' | jq -r '."Airport Name"')"
          git push origin ${{ steps.extract.outputs.branch_name }}

      - name: Create PR
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Update airport: '${{ steps.extract.outputs.fields }}' | jq -r '."Airport Name"'"
          branch: ${{ steps.extract.outputs.branch_name }}
          base: main
          labels: awaiting-review
          body: |
            Automated airport update from issue #${{ github.event.issue.number }}
            
            **Changes:**
            ```diff
            -${{ steps.existing.outputs.row }}
            +${{ steps.merge.outputs.updated_row }}
            ```

      - name: Comment on Issue
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const prUrl = '${{ steps.create-pr.outputs.pull-request-url }}' || 'N/A';
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ðŸš€ Update processed! ${prUrl ? `[View PR](${prUrl})` : ''}`
            });