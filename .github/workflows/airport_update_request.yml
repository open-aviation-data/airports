name: Process Airport Updates

on:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  process-update:
    if: contains(github.event.issue.labels.*.name, 'update airport')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Extract issue data
        id: extract_data
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const fields = {};
            let errors = [];
            
            // Split issue body into lines and extract key/value pairs based on headers.
            const bodyLines = issue.body.split('\n');
            let lastKey = null;
            for (const line of bodyLines) {
              const match = line.match(/^### (.+)$/);
              if (match) {
                lastKey = match[1].trim();
                fields[lastKey] = "";
              } else if (lastKey) {
                const value = line.trim();
                if (value && value !== "_No response_") {
                  fields[lastKey] += (fields[lastKey] ? " " : "") + value;
                }
              }
            }
            
            // Validate required fields.
            if (!fields['Numeric ID']) {
              errors.push('Missing required field: Numeric ID');
            }
            if (!fields['Airport Name']) {
              errors.push('Missing required field: Airport Name');
            }
            
            // Convert Numeric ID to integer.
            fields['Numeric ID'] = fields['Numeric ID'] ? parseInt(fields['Numeric ID'], 10) : 0;
            
            core.setOutput('fields', JSON.stringify(fields));
            
            // Function to sanitize branch names.
            function sanitizeBranchName(input) {
              return input
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-zA-Z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .toLowerCase()
                .slice(0, 40);
            }
            
            const sanitizedAirportName = sanitizeBranchName(fields['Airport Name'] || 'unknown');
            const branchName = `update-airport-${fields['Numeric ID']}-${sanitizedAirportName}`;
            core.setOutput('branch_name', branchName);
            core.exportVariable('ERRORS', errors.join("; "));

      - name: Check if numeric ID exists in CSV
        id: check_numeric_id
        run: |
          NUMERIC_ID=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Numeric ID"')
          if grep -q "^${NUMERIC_ID}," data/airports.csv; then
            echo "ID_FOUND=true" >> $GITHUB_ENV
          else
            echo "ID_FOUND=false" >> $GITHUB_ENV
            echo "ERRORS=${ERRORS}; Numeric ID not found in CSV" >> $GITHUB_ENV
            echo "Exiting workflow because Numeric ID was not found in CSV"
            exit 1
          fi

      - name: Get Existing Data
        id: existing
        run: |
          NUMERIC_ID=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Numeric ID"')
          echo "row=$(grep "^$NUMERIC_ID," data/airports.csv)" >> $GITHUB_OUTPUT

      - name: Merge Data
        id: merge
        run: |
          IFS=',' read -ra OLD < <(echo "${{ steps.existing.outputs.row }}")
          FIELDS='${{ steps.extract_data.outputs.fields }}'
          
          # Map issue fields to CSV columns (0-based index)
          declare -A COLUMN_MAP=(
            ["ICAO Code"]=2
            ["IATA Code"]=3
            ["Airport Name"]=6
            ["Latitude"]=7
            ["Longitude"]=8
            ["Country"]=11
            ["Municipality"]=13
            ["New Official Website URL (if applicable)"]=15
            ["New Wikipedia URL (if applicable)"]=16
            ["Keywords"]=17
            ["Timezone"]=18
            ["Airport Type (if changing)"]=19
          )
          
          NEW_ROW=()
          for i in "${!OLD[@]}"; do
            NEW_ROW[i]="${OLD[$i]}"
          done
          
          # Update fields from issue
          for field in "${!COLUMN_MAP[@]}"; do
            value=$(jq -r ".[\"$field\"] // empty" <<< "$FIELDS")
            index=${COLUMN_MAP[$field]}
          
            if [ -n "$value" ] && [ "$value" != "None" ] && [ "$value" != "No Change" ]; then
              NEW_ROW[$index]="$value"
            fi
          done
          
          # Join array back to CSV
          UPDATED_ROW=$(IFS=','; echo "${NEW_ROW[*]}")
          echo "updated_row=$UPDATED_ROW" >> $GITHUB_OUTPUT

      - name: Create Branch
        run: |
          git checkout -b ${{ steps.extract_data.outputs.branch_name }}
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Update CSV
        run: |
          NUMERIC_ID=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Numeric ID"')
          awk -v id="$NUMERIC_ID" -v new="${{ steps.merge.outputs.updated_row }}" '
            BEGIN {FS=OFS=","} 
            $1 == id {$0 = new} 
            {print}
          ' data/airports.csv > tmp.csv && mv tmp.csv data/airports.csv

      - name: Debug CSV Changes
        run: |
          git status
          cat data/airports.csv | grep "$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Numeric ID"')" || echo "No changes found"

      - name: Commit Changes
        run: |
          git add data/airports.csv
          if git diff --cached --quiet; then
            echo "No changes to commit. Exiting."
            exit 1
          fi
          git commit -m "Update airport"
          git push origin ${{ steps.extract_data.outputs.branch_name }}

      - name: Debug Git State Before PR
        run: |
          echo "ğŸ” Checking Git Status..."
          git status
          echo "ğŸ” Recent commits:"
          git log --oneline -5
          echo "ğŸ” Branch info:"
          git branch -vv

      - name: Create Pull Request
        if: success()
        uses: actions/github-script@v6
        id: create-pr
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const { owner, repo } = context.repo;
              const result = await github.rest.pulls.create({
                owner,
                repo,
                title: 'ğŸ›« Update airport',
                head: '${{ steps.extract_data.outputs.branch_name }}',
                base: 'main',
                body: `Automated airport update from issue #${context.payload.issue.number}
            
                **Changes:**
                \`\`\`diff
                -${{ steps.existing.outputs.row }}
                +${{ steps.merge.outputs.updated_row }}
                \`\`\``,
              });
            
              // Add label to the PR
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: result.data.number,
                labels: ['awaiting-review']
              });
            
              console.log(`Pull request created: #${result.data.number}`);
              core.setOutput('pull_request_number', result.data.number);
              core.setOutput('pull_request_url', result.data.html_url);
              return result.data.html_url;
            } catch (error) {
              core.setFailed(`Failed to create PR: ${error.message}`);
              return null;
            }

      - name: Check outputs
        if: ${{ steps.cpr.outputs.pull-request-number }}
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"

      - name: Comment on Issue
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const prUrl = '${{ steps.create-pr.outputs.pull-request-url }}' || 'N/A';
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ğŸš€ Update processed! ${prUrl ? `[View PR](${prUrl})` : ''}`
            });