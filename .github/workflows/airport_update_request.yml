name: Process Update Airport Requests

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  validate-and-update-pr:
    if: contains(github.event.issue.labels.*.name, 'update airport')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract issue data
        id: extract_data
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const fields = {};
            let errors = [];
            
            const bodyLines = issue.body.split('\n');
            let lastKey = null;
            
            for (const line of bodyLines) {
              // Match header lines (e.g., "### Airport Name")
              let match = line.match(/^### (.+)$/);
            
              if (match) {
                lastKey = match[1].trim();
                fields[lastKey] = ""; // Initialize key
              } else if (lastKey) {
                // Handle multi-line values, but ignore "_No response_"
                const value = line.trim();
            
                if (value && value !== "_No response_") {
                  fields[lastKey] += (fields[lastKey] ? " " : "") + value;
                }
              }
            }
            
            // Check required fields
            if (!fields['Numeric ID']) {
              errors.push('Missing required field: Numeric ID');
            }
            if (!fields['Airport Name']) {
              errors.push('Missing required field: Airport Name');
            }
              
            // Convert Numeric ID to integer
            fields['Numeric ID'] = fields['Numeric ID'] ? parseInt(fields['Numeric ID'], 10) : 0;
              
            core.setOutput('fields', JSON.stringify(fields));            
            function sanitizeBranchName(input) {
              return input
                .normalize('NFD') // Remove diacritics (e.g., √© ‚Üí e)
                .replace(/[\u0300-\u036f]/g, '') // Strip special marks
                .replace(/[^a-zA-Z0-9\s-]/g, '') // Keep letters, numbers, spaces, and hyphens
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/-+/g, '-') // Remove duplicate hyphens
                .toLowerCase()
                .slice(0, 40); // Limit to 40 characters for safety
            }
            
            const sanitizedAirportName = sanitizeBranchName(fields['Airport Name'] || 'unknown');
            const branchName = `update-airport-${fields['Numeric ID']}-${sanitizedAirportName}`;
            core.setOutput('branch_name', branchName);
            core.exportVariable('ERRORS', errors.join("; "));

      - name: Check if numeric ID exists in CSV
        id: check_numeric_id
        run: |
          NUMERIC_ID=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Numeric ID"')
          if grep -q "^${NUMERIC_ID}," data/airports.csv; then
            echo "ID_FOUND=true" >> $GITHUB_ENV
          else
            echo "ID_FOUND=false" >> $GITHUB_ENV
            echo "ERRORS=${ERRORS}; Numeric ID not found in CSV" >> $GITHUB_ENV
          fi

      - name: Fetch existing airport row
        id: fetch_existing_data
        run: |
          if [ "$ID_FOUND" = "true" ]; then
            NUMERIC_ID=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Numeric ID"')
            EXISTING_ROW=$(grep "^${NUMERIC_ID}," data/airports.csv)
            echo "EXISTING_ROW=${EXISTING_ROW}" >> $GITHUB_ENV
          else
            echo "EXISTING_ROW=" >> $GITHUB_ENV
          fi

      - name: Merge existing and new data
        id: merge_data
        run: |
          if [ "$ID_FOUND" = "true" ]; then
            # Extract Numeric ID from JSON.
            NUMERIC_ID=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Numeric ID"')

            # Get the existing CSV row.
            EXISTING_ROW=$(echo "${EXISTING_ROW}")

            # Split the CSV row into an array (assuming 20 columns).
            OLD_DATA=($(echo "${EXISTING_ROW}" | awk -F, '{ for (i=1; i<=NF; i++) print $i }'))

            # Save the JSON fields into a variable.
            NEW_DATA_JSON='${{ steps.extract_data.outputs.fields }}'

            # Helper function to get a field value from the JSON.
            get_field() {
              echo $(echo "$NEW_DATA_JSON" | jq -r --arg key "$1" '.[$key] // empty')
            }

            # For each field, use the new value if available; otherwise, use the old value.
            # Column 0: id (from Numeric ID)
            UPDATED_ROW="$NUMERIC_ID"

            # Column 1: ident (preserve old value)
            updated_ident="${OLD_DATA[1]}"
            UPDATED_ROW+=",\"${updated_ident}\""

            # Column 2: icao -> from "ICAO Code"
            new_icao=$(get_field 'ICAO Code')
            if [ -z "$new_icao" ]; then new_icao="${OLD_DATA[2]}"; fi
            UPDATED_ROW+=",\"${new_icao}\""

            # Column 3: iata -> from "IATA Code"
            new_iata=$(get_field 'IATA Code')
            if [ -z "$new_iata" ]; then new_iata="${OLD_DATA[3]}"; fi
            UPDATED_ROW+=",\"${new_iata}\""

            # Column 4: gps_code (preserve old value)
            UPDATED_ROW+=",\"${OLD_DATA[4]}\""

            # Column 5: local_code (preserve old value)
            UPDATED_ROW+=",\"${OLD_DATA[5]}\""

            # Column 6: name -> from "Airport Name"
            new_name=$(get_field 'Airport Name')
            if [ -z "$new_name" ]; then new_name="${OLD_DATA[6]}"; fi
            UPDATED_ROW+=",\"${new_name}\""

            # Column 7: latitude -> from "Latitude"
            new_lat=$(get_field 'Latitude')
            if [ -z "$new_lat" ]; then new_lat="${OLD_DATA[7]}"; fi
            UPDATED_ROW+=",\"${new_lat}\""

            # Column 8: longitude -> from "Longitude"
            new_long=$(get_field 'Longitude')
            if [ -z "$new_long" ]; then new_long="${OLD_DATA[8]}"; fi
            UPDATED_ROW+=",\"${new_long}\""

            # Column 9: elevation (preserve old value)
            UPDATED_ROW+=",\"${OLD_DATA[9]}\""

            # Column 10: continent (preserve old value)
            UPDATED_ROW+=",\"${OLD_DATA[10]}\""

            # Column 11: country -> from "Country"
            new_country=$(get_field 'Country')
            if [ -z "$new_country" ]; then new_country="${OLD_DATA[11]}"; fi
            UPDATED_ROW+=",\"${new_country}\""

            # Column 12: region (preserve old value)
            UPDATED_ROW+=",\"${OLD_DATA[12]}\""

            # Column 13: municipality -> from "Municipality"
            new_muni=$(get_field 'Municipality')
            if [ -z "$new_muni" ]; then new_muni="${OLD_DATA[13]}"; fi
            UPDATED_ROW+=",\"${new_muni}\""

            # Column 14: scheduled_service (preserve old value)
            UPDATED_ROW+=",\"${OLD_DATA[14]}\""

            # Column 15: web_url -> from "New Official Website URL (if applicable)"
            new_web=$(get_field 'New Official Website URL (if applicable)')
            if [ -z "$new_web" ]; then new_web="${OLD_DATA[15]}"; fi
            UPDATED_ROW+=",\"${new_web}\""

            # Column 16: wikipedia_url -> from "New Wikipedia URL (if applicable)"
            new_wiki=$(get_field 'New Wikipedia URL (if applicable)')
            if [ -z "$new_wiki" ]; then new_wiki="${OLD_DATA[16]}"; fi
            UPDATED_ROW+=",\"${new_wiki}\""

            # Column 17: keywords -> from "Keywords"
            new_keywords=$(get_field 'Keywords')
            if [ -z "$new_keywords" ]; then new_keywords="${OLD_DATA[17]}"; fi
            UPDATED_ROW+=",\"${new_keywords}\""

            # Column 18: timezone -> from "Timezone"
            new_tz=$(get_field 'Timezone')
            if [ -z "$new_tz" ]; then new_tz="${OLD_DATA[18]}"; fi
            UPDATED_ROW+=",\"${new_tz}\""

            # Column 19: airport_type -> from "Airport Type (if changing)"
            new_type=$(get_field 'Airport Type (if changing)')
            # If new_type is "None", "No Change", or empty, use the old value.
            if [ "$new_type" = "None" ] || [ "$new_type" = "No Change" ] || [ -z "$new_type" ]; then
              new_type="${OLD_DATA[19]}"
            fi
            UPDATED_ROW+=",\"${new_type}\""

            # Debug: Output the merged UPDATED_ROW
            echo "UPDATED_ROW=${UPDATED_ROW}" >> $GITHUB_ENV
          else
            echo "UPDATED_ROW=" >> $GITHUB_ENV
          fi

      - name: Create new branch
        run: |
          BRANCH_NAME="${{ steps.extract_data.outputs.branch_name }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --global credential.helper store
          
          # Checkout the new branch
          git checkout -b "$BRANCH_NAME"
          
          # Authenticate with GitHub
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          
          # Push the new branch
          git push --set-upstream origin "$BRANCH_NAME"

      - name: Update CSV
        run: |
          # Only update the CSV if the numeric ID exists and no errors were reported.
          if [ "$ID_FOUND" = "true" ] && [ -n "${UPDATED_ROW}" ] && [ -z "$ERRORS" ]; then
            NUMERIC_ID=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Numeric ID"')

            # Debug: Print extracted numeric ID
            echo "Extracted Numeric ID: $NUMERIC_ID"

            # Ensure NUMERIC_ID is a valid integer
            if ! [[ "$NUMERIC_ID" =~ ^[0-9]+$ ]]; then
              echo "Error: Invalid or missing Numeric ID: '$NUMERIC_ID'"
              exit 1
            fi

            # Update the CSV file using awk
            awk -v num_id="$NUMERIC_ID" -v updated_row="${UPDATED_ROW}" \
              'BEGIN { FS=OFS="," } $1 == num_id { $0 = updated_row } 1' \
              data/airports.csv > tmp.csv && mv tmp.csv data/airports.csv

            git add data/airports.csv

            # Commit the changes
            git commit -m "Updated airport: $(jq -r '.["Airport Name"]' <<< '${{ steps.extract_data.outputs.fields }}') (Numeric ID: $(jq -r '.["Numeric ID"]' <<< '${{ steps.extract_data.outputs.fields }}'))"

            # Ensure BRANCH_NAME is correctly set
            BRANCH_NAME="${{ steps.extract_data.outputs.branch_name }}"
            if [ -z "$BRANCH_NAME" ]; then
              echo "Error: BRANCH_NAME is empty!"
              exit 1
            fi

            # Debugging: Print branch name
            echo "Pushing to branch: $BRANCH_NAME"

            # Pull latest remote changes and rebase local commits
            git pull --rebase origin "$BRANCH_NAME"

            # Force push (with lease) to update the remote branch if necessary
            git push --force-with-lease origin "$BRANCH_NAME"
          else
            echo "Skipping CSV update due to errors or missing numeric ID."
          fi

      - name: Convert JSON to env variables
        id: convert_json
        run: |
          echo "NUMERIC_ID=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Numeric ID"')" >> $GITHUB_ENV
          echo "AIRPORT_NAME=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Airport Name"')" >> $GITHUB_ENV
          echo "IATA_CODE=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."IATA Code"')" >> $GITHUB_ENV
          echo "ICAO_CODE=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."ICAO Code"')" >> $GITHUB_ENV
          echo "MUNICIPALITY=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Municipality"' )" >> $GITHUB_ENV
          echo "AIRPORT_TYPE=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Airport Type (if changing)"' )" >> $GITHUB_ENV
          echo "LATITUDE=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Latitude"')" >> $GITHUB_ENV
          echo "LONGITUDE=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Longitude"')" >> $GITHUB_ENV
          echo "WEBSITE=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."New Official Website URL (if applicable)"')" >> $GITHUB_ENV
          echo "WIKIPEDIA=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."New Wikipedia URL (if applicable)"')" >> $GITHUB_ENV
          echo "KEYWORDS=$(echo '${{ steps.extract_data.outputs.fields }}' | jq -r '."Keywords"' )" >> $GITHUB_ENV

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          title: "üõ´ Update airport: ${{ env.AIRPORT_NAME }}"
          body: |
            This PR was **automatically generated** from an airport update request issue.

            ### ‚úàÔ∏è Updated Airport Details:
            - **Name:** ${{ env.AIRPORT_NAME }}
            - **IATA:** ${{ env.IATA_CODE }}
            - **ICAO:** ${{ env.ICAO_CODE }}
            - **Municipality:** ${{ env.MUNICIPALITY }}
            - **Airport Type:** ${{ env.AIRPORT_TYPE }}
            - **Latitude:** ${{ env.LATITUDE }}
            - **Longitude:** ${{ env.LONGITUDE }}
            - **Website:** ${{ env.WEBSITE }}
            - **Wikipedia:** ${{ env.WIKIPEDIA }}
            - **Keywords:** ${{ env.KEYWORDS }}

            üè∑Ô∏è Label: `awaiting review`  
            üîé **Maintainers:** Please validate this update before merging.
          branch: "${{ steps.extract_data.outputs.branch_name }}"
          base: main
          labels: "awaiting review"

      - name: Comment on Issue
        uses: actions/github-script@v6
        env:
          EXISTING_ROW: ${{ env.EXISTING_ROW }}
          NEW_FIELDS: ${{ steps.extract_data.outputs.fields }}
          PULL_REQUEST_URL: ${{ steps.create_pr.outputs.pull_request_url }}
          ERRORS: ${{ env.ERRORS }}
        with:
          script: |
            // Parse the old CSV row.
            const oldRow = process.env.EXISTING_ROW || "";
            const oldValues = oldRow.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(val => val.replace(/^"|"$/g, ''));
            
            // Parse the new fields from the issue.
            const newFields = JSON.parse(process.env.NEW_FIELDS);
            
            // Define the fields to show.
            const fields = [
              "ICAO Code", 
              "IATA Code", 
              "Airport Name", 
              "Latitude", 
              "Longitude", 
              "Country", 
              "Municipality",
              "Website",
              "Wikipedia",
              "Keywords",
              "Timezone", 
              "Airport Type" 
            ];
            const fieldIndices = {
              "ICAO Code": 2,
              "IATA Code": 3,
              "Airport Name": 6,
              "Latitude": 7,
              "Longitude": 8,
              "Country": 11,
              "Municipality": 13,
              "Website": 15,
              "Wikipedia": 16,
              "Keywords": 17,
              "Timezone": 18,
              "Airport Type": 19
            };

            let table = "| Field | Before | After |\n";
            table += "| --- | --- | --- |\n";
            fields.forEach(field => {
              const idx = fieldIndices[field];
              const oldVal = (oldValues[idx] || "").trim();
              const newVal = (newFields[field] || "").trim() || oldVal;
              const displayOld = oldVal === "" ? "*empty*" : oldVal;
              const displayNew = newVal === "" ? "*empty*" : newVal;
              table += `| ${field} | ${displayOld} | ${displayNew} |\n`;
            });

            let errorSection = "";
            if (process.env.ERRORS && process.env.ERRORS.trim() !== "") {
              errorSection = "\n\n### Errors / Issues Found\n\n" + process.env.ERRORS;
            }

            const prUrl = process.env.PULL_REQUEST_URL;
            const issueNumber = context.payload.issue.number;
            const body = `‚úÖ **This request has been processed automatically.**\n\n` +
                         `üìÑ A **Pull Request** has been created: [View PR](${prUrl})\n\n` +
                         `### Changes Overview\n\n` +
                         `${table}` +
                         errorSection + "\n\n" +
                         `üè∑Ô∏è Label: \`awaiting review\`\n` +
                         `üöÄ Maintainers will review this update before merging.`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });
